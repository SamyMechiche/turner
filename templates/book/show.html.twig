{% extends 'bottomMenu.twig' %}

{% block title %}{{ book.title }}{% endblock %}

{% block stylesheets %}
<style>
    @font-face {
        font-family: jeju;
        src: url("public/fonts/jeju/JejuMyeongjo-Regular.ttf");
    }

    @font-face {
        font-family: outfitR;
        src: url("public/fonts/jeju/outfit/Outfit-Regular.ttf");
    }

    :root {
        --font-title: outfitR;
        --color-bg: #FBF3D1;
        --color-heading: #463F33;
        --color-border: #D4C5A9;
        --color-text: #8B7355;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background-color: var(--color-bg);
        font-family: serif;
        min-height: 100vh;
        padding: 2rem 1.5rem;
        padding-bottom: 10rem; /* Space for bottom menu */
    }

    .book-detail-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--color-heading);
        text-decoration: none;
        font-family: jeju, serif;
        font-size: 1rem;
        margin-bottom: 2rem;
        transition: opacity 0.2s;
    }

    .back-link:hover {
        opacity: 0.7;
    }

    .book-header {
        display: flex;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .book-cover-large {
        width: 200px;
        aspect-ratio: 2/3;
        background-color: var(--color-heading);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-bg);
        font-size: 2rem;
        text-align: center;
        padding: 0.3rem;
        box-sizing: border-box;
        overflow: hidden;
        flex-shrink: 0;
    }

    .book-cover-large img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .book-title-large {
        font-family: outfitR, sans-serif;
        font-size: 1rem;
        color: var(--color-heading);
        margin-bottom: 0.5rem;
    }

    .book-author-large {
        font-family: jeju, serif;
        font-size: 1.2rem;
        color: var(--color-heading);
        opacity: 0.8;
        margin-bottom: 1rem;
    }

    .book-meta-info {
        font-family: jeju, serif;
        font-size: 1rem;
        color: var(--color-heading);
        opacity: 0.7;
        margin-bottom: 0.5rem;
    }

    .section {
        margin-bottom: 2.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid var(--color-heading);
    }

    .section-title {
        font-family: outfitR, sans-serif;
        font-size: 1.5rem;
        color: var(--color-heading);
        letter-spacing: 0.1rem;
        margin-bottom: 1rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .add-note-btn {
        border: none;
        background-color: var(--color-heading);
        color: var(--color-bg);
        font-family: jeju, serif;
        padding: 0.5rem 1rem;
        border-radius: 999px;
        cursor: pointer;
        transition: opacity 0.2s ease, transform 0.2s ease;
        font-size: 0.9rem;
    }

    .add-note-btn:hover {
        opacity: 0.85;
        transform: translateY(-1px);
    }

    .progress-section {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .progress-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background-color: rgba(255, 255, 255, 0.5);
        border-radius: 8px;
        border: 1px solid rgba(70, 63, 51, 0.2);
    }

    .progress-label {
        font-family: outfitR, sans-serif;
        font-size: 1rem;
        color: var(--color-heading);
    }

    .progress-value {
        font-family: jeju, serif;
        font-size: 1rem;
        color: var(--color-heading);
        font-weight: bold;
    }

    .progress-bar-container {
        width: 100%;
        height: 20px;
        background-color: rgba(70, 63, 51, 0.1);
        border-radius: 10px;
        overflow: hidden;
        margin-top: 0.5rem;
    }

    .progress-bar {
        height: 100%;
        background-color: var(--color-heading);
        transition: width 0.3s ease;
    }

    .notes-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .note-item {
        padding: 1rem;
        background-color: rgba(255, 255, 255, 0.5);
        border-radius: 8px;
        border: 1px solid rgba(70, 63, 51, 0.2);
    }

    .note-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .note-page {
        font-family: jeju, serif;
        font-size: 0.9rem;
        color: var(--color-heading);
        opacity: 0.7;
    }

    .note-date {
        font-family: jeju, serif;
        font-size: 0.85rem;
        color: var(--color-heading);
        opacity: 0.6;
    }

    .note-content {
        font-family: jeju, serif;
        font-size: 1rem;
        color: var(--color-heading);
        line-height: 1.6;
        white-space: pre-wrap;
    }

    .empty-state {
        font-family: jeju, serif;
        color: var(--color-heading);
        opacity: 0.5;
        font-style: italic;
        padding: 1rem 0;
        text-align: center;
    }

    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.2s ease, visibility 0.2s ease;
        z-index: 1000;
    }

    .modal-overlay.is-visible {
        visibility: visible;
        opacity: 1;
    }

    .note-modal {
        width: min(500px, 100%);
        background: #fff;
        border-radius: 16px;
        padding: 2rem;
        position: relative;
        border: 2px solid var(--color-heading);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    }

    .note-modal h3 {
        font-family: outfitR, sans-serif;
        color: var(--color-heading);
        margin-bottom: 1rem;
        letter-spacing: 0.05rem;
    }

    .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        border: none;
        background: transparent;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--color-heading);
    }

    .note-form-group {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        margin-bottom: 1rem;
        font-family: jeju, serif;
        color: var(--color-heading);
    }

    .note-form-group input,
    .note-form-group textarea {
        border: 1px solid var(--color-border);
        border-radius: 8px;
        padding: 0.75rem;
        font-family: jeju, serif;
        font-size: 1rem;
        background-color: rgba(251, 243, 209, 0.4);
    }

    .note-form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }

    .modal-submit-btn {
        border: none;
        background-color: var(--color-heading);
        color: var(--color-bg);
        font-family: outfitR, sans-serif;
        padding: 0.75rem 1.5rem;
        border-radius: 999px;
        cursor: pointer;
        transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .modal-submit-btn:hover {
        opacity: 0.85;
        transform: translateY(-1px);
    }

    .modal-cancel-btn {
        border: none;
        background-color: transparent;
        color: var(--color-heading);
        font-family: outfitR, sans-serif;
        cursor: pointer;
        text-decoration: underline;
    }

    .not-in-collection {
        padding: 1.5rem;
        background-color: rgba(255, 255, 255, 0.5);
        border-radius: 8px;
        border: 1px solid rgba(70, 63, 51, 0.2);
        text-align: center;
        font-family: jeju, serif;
        color: var(--color-heading);
    }

    .objectives-form {
        padding: 1.5rem;
        border: 1px solid rgba(70, 63, 51, 0.2);
        margin-bottom: 2rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        font-family: jeju, serif;
        font-size: 1rem;
        color: var(--color-heading);
        display: block;
        margin-bottom: 0.5rem;
    }

    .form-group input[type="number"],
    .form-group input[type="date"] {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--color-border);
        border-radius: 8px;
        background-color: var(--color-bg);
        font-size: 1rem;
        color: var(--color-heading);
        font-family: jeju, serif;
        outline: none;
        transition: border-color 0.2s;
    }

    .form-group input[type="number"]:focus,
    .form-group input[type="date"]:focus {
        border-color: var(--color-heading);
    }

    .form-radio-group {
        display: flex;
        gap: 1.5rem;
        margin-bottom: 1rem;
    }

    .form-radio-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-radio-item input[type="radio"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .form-radio-item label {
        font-family: jeju, serif;
        font-size: 1rem;
        color: var(--color-heading);
        cursor: pointer;
        margin: 0;
    }

    .calculated-value {
        margin-top: 0.5rem;
        padding: 0.75rem;
        background-color: rgba(70, 63, 51, 0.1);
        border-radius: 6px;
        font-family: jeju, serif;
        font-size: 0.95rem;
        color: var(--color-heading);
    }

    .calculated-value strong {
        font-weight: bold;
    }

    .btn-submit {
        width: 100%;
        padding: 0.875rem 1.5rem;
        background-color: var(--color-heading);
        color: var(--color-bg);
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-family: jeju, serif;
        cursor: pointer;
        transition: opacity 0.2s;
        margin-top: 1rem;
    }

    .btn-submit:hover {
        opacity: 0.9;
    }

    .btn-submit:active {
        opacity: 0.8;
    }

    .add-daily-btn{
        border: none;
        background-color: var(--color-heading);
        color: var(--color-bg);
        font-family: outfitR, sans-serif;
        padding: 0.5rem 1rem;
        border-radius: 999px;
        cursor: pointer;
        transition: opacity 0.2s ease, transform 0.2s ease;
        font-size: 0.9rem;
    }
    .add-daily-btn.is-complete {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .form-errors {
        color: #d32f2f;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        font-family: jeju, serif;
    }

    .alert {
        padding: 0.75rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-family: jeju, serif;
    }

    .alert-success {
        background-color: #e8f5e9;
        color: #2e7d32;
    }

    .alert-error {
        background-color: #ffebee;
        color: #d32f2f;
    }
</style>
{% endblock %}

{% block body %}
<div class="book-detail-container">
    <a href="{{ path('app_logged_home') }}" class="back-link">
        ‚Üê Back to Home
    </a>

    <div class="book-header">
        <div class="book-cover-large">
            {% if book.coverImage %}
                <img src="{{ book.coverImage }}" alt="{{ book.title }} cover">
            {% else %}
                <span>{{ book.title|slice(0, 3)|upper }}</span>
            {% endif %}
        </div>
        <div class="book-info-header">
            <h1 class="book-title-large">{{ book.title }}</h1>
            {% if book.author %}
                <div class="book-author-large">{{ book.author }}</div>
            {% endif %}
            {% if book.editor %}
                <div class="book-meta-info">Publisher: {{ book.editor }}</div>
            {% endif %}
            {% if book.totalPages %}
                <div class="book-meta-info">{{ book.totalPages }} pages</div>
            {% endif %}
        </div>
    </div>

    {% if userBook %}
        {# Objectives Form Section #}
        <div class="section">
            <h2 class="section-title">Set Your Objectives</h2>
            <div class="objectives-form">
                {% for message in app.flashes('success') %}
                    <div class="alert alert-success" role="alert">{{ message }}</div>
                {% endfor %}

                {% for message in app.flashes('error') %}
                    <div class="alert alert-error" role="alert">{{ message }}</div>
                {% endfor %}

                {% if form %}
                    {{ form_start(form, {'action': path('app_book_update', {id: book.id}), 'method': 'POST'}) }}
                    
                    <div class="form-group">
                        {{ form_label(form.objective_type) }}
                        <div class="form-radio-group">
                            {% for child in form.objective_type %}
                                <div class="form-radio-item">
                                    {{ form_widget(child) }}
                                    {{ form_label(child) }}
                                </div>
                            {% endfor %}
                        </div>
                        {{ form_errors(form.objective_type) }}
                    </div>

                    <div class="form-group" id="daily-goal-group">
                        {{ form_label(form.daily_goal) }}
                        {{ form_widget(form.daily_goal) }}
                        {{ form_errors(form.daily_goal) }}
                        {% if userBook.dailyGoal and userBook.deadline %}
                            {% set currentPage = userBook.currentPage ?? 0 %}
                            {% set remainingPages = book.totalPages - currentPage %}
                            {% if remainingPages > 0 %}
                                <div class="calculated-value">
                                    <strong>Calculated finish date:</strong> {{ userBook.deadline|date('M d, Y') }}
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>

                    <div class="form-group" id="deadline-group">
                        {{ form_label(form.deadline) }}
                        {{ form_widget(form.deadline) }}
                        {{ form_errors(form.deadline) }}
                        {% if userBook.deadline and userBook.dailyGoal %}
                            {% set currentPage = userBook.currentPage ?? 0 %}
                            {% set remainingPages = book.totalPages - currentPage %}
                            {% if remainingPages > 0 %}
                                <div class="calculated-value">
                                    <strong>Required pages per day:</strong> {{ userBook.dailyGoal }} pages
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>

                    <div class="form-group">
                        {{ form_label(form.current_page) }}
                        {{ form_widget(form.current_page) }}
                        {{ form_errors(form.current_page) }}
                    </div>

                    <button type="submit" class="btn-submit">Update Objectives</button>
                    {{ form_end(form) }}
                {% endif %}
            </div>
        </div>

        {# Progress Section #}
        <div class="section">
            <h2 class="section-title">Your Progress</h2>
            <div class="progress-section">
                {% if userBook.currentPage is not null and book.totalPages %}
                    <div class="progress-item">
                        <div>
                            <div class="progress-label">Current Page</div>
                            <div class="progress-value" id="current-page-value">{{ userBook.currentPage }} / {{ book.totalPages }}</div>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        {% set progressPercent = (userBook.currentPage / book.totalPages * 100)|round %}
                        <div class="progress-bar" id="progress-bar" style="width: {{ progressPercent }}%"></div>
                    </div>
                {% else %}
                    <div class="empty-state">No progress tracked yet</div>
                {% endif %}

                {% if userBook.dailyGoal %}
                    <div class="progress-item">
                        <span class="progress-label">Daily Goal</span>
                        <span class="progress-value" id="daily-goal-value">{{ userBook.dailyGoal }} pages/day</span>
                        {% if userBook.currentPage is not null and book.totalPages %}
                            <button
                                type="button"
                                class="add-daily-btn"
                                id="add-daily-btn"
                                style="margin-left:1rem;"
                                data-add-daily-url="{{ path('app_book_add_daily', {'id': book.id}) }}"
                                data-csrf-token="{{ csrf_token('add_daily_' ~ userBook.id) }}"
                            >
                                Add daily pages
                            </button>
                        {% endif %}
                    </div>
                {% endif %}

                {% if userBook.deadline %}
                    <div class="progress-item">
                        <span class="progress-label">Deadline</span>
                        <span class="progress-value">{{ userBook.deadline|date('M d, Y') }}</span>
                    </div>
                {% endif %}

                {% if userBook.progress is not null %}
                    <div class="progress-item">
                        <span class="progress-label">Progress</span>
                        <span class="progress-value" id="progress-percent-value">{{ userBook.progress|round }}%</span>
                    </div>
                {% endif %}
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const addDailyButton = document.getElementById('add-daily-btn');
                if (addDailyButton) {
                    const addDailyUrl = addDailyButton.dataset.addDailyUrl;
                    const csrfToken = addDailyButton.dataset.csrfToken;
                    const currentPageElem = document.getElementById('current-page-value');
                    const progressBar = document.getElementById('progress-bar');
                    const progressPercentElem = document.getElementById('progress-percent-value');

                    addDailyButton.addEventListener('click', async function() {
                        if (!addDailyUrl || !csrfToken || !currentPageElem || !progressBar) {
                            return;
                        }

                        const originalLabel = addDailyButton.textContent.trim() || 'Add daily pages';
                        addDailyButton.disabled = true;
                        addDailyButton.textContent = 'Updating...';

                        try {
                            const response = await fetch(addDailyUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'X-CSRF-TOKEN': csrfToken,
                                },
                                body: JSON.stringify({}),
                            });

                            const data = await response.json();

                            if (!response.ok) {
                                throw new Error(data.message || 'Unable to update progress.');
                            }

                            if (typeof data.currentPage !== 'undefined' && typeof data.totalPages !== 'undefined') {
                                currentPageElem.textContent = data.currentPage + ' / ' + data.totalPages;
                            }

                            if (progressBar && typeof data.progressPercent === 'number') {
                                progressBar.style.width = data.progressPercent + '%';
                            }

                            if (progressPercentElem && typeof data.progressPercent === 'number') {
                                progressPercentElem.textContent = data.progressPercent + '%';
                            }

                            if (data.isComplete) {
                                addDailyButton.textContent = 'Completed';
                                addDailyButton.classList.add('is-complete');
                            } else {
                                addDailyButton.disabled = false;
                                addDailyButton.textContent = originalLabel;
                            }

                            if (data.message) {
                                console.info(data.message);
                            }
                        } catch (error) {
                            alert(error.message || 'Unable to update progress. Please try again.');
                            addDailyButton.disabled = false;
                            addDailyButton.textContent = originalLabel;
                        }
                    });
                }
            });
        </script>

        {# Notes Section #}
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Your Notes</h2>
                {% if noteForm %}
                    <button type="button" class="add-note-btn" id="open-note-modal">Add Note</button>
                {% endif %}
            </div>
            <div class="notes-container">
                {% if userBook.notes|length > 0 %}
                    {% for note in userBook.notes %}
                        <div class="note-item">
                            <div class="note-header">
                                {% if note.page %}
                                    <span class="note-page">Page {{ note.page }}</span>
                                {% else %}
                                    <span class="note-page">General Note</span>
                                {% endif %}
                                <span class="note-date">{{ note.createdAt|date('M d, Y') }}</span>
                            </div>
                            {% if note.content %}
                                <div class="note-content">{{ note.content }}</div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">No notes yet. Start reading to add your thoughts!</div>
                {% endif %}
            </div>
            {% if noteForm %}
                <div class="modal-overlay" id="note-modal" aria-hidden="true">
                    <div class="note-modal" role="dialog" aria-modal="true" aria-labelledby="note-modal-title">
                        <button type="button" class="modal-close" id="close-note-modal" aria-label="Close modal">&times;</button>
                        <h3 id="note-modal-title">Add a Note</h3>
                        {{ form_start(noteForm, {'attr': {'id': 'note-form'}}) }}
                        <div class="note-form-group">
                            {{ form_label(noteForm.page) }}
                            {{ form_widget(noteForm.page) }}
                            {{ form_errors(noteForm.page) }}
                        </div>
                        <div class="note-form-group">
                            {{ form_label(noteForm.content) }}
                            {{ form_widget(noteForm.content) }}
                            {{ form_errors(noteForm.content) }}
                        </div>
                        {{ form_rest(noteForm) }}
                        <div class="note-form-actions">
                            <button type="button" class="modal-cancel-btn" id="cancel-note-modal">Cancel</button>
                            <button type="submit" class="modal-submit-btn">Save Note</button>
                        </div>
                        {{ form_end(noteForm, {'render_rest': false}) }}
                    </div>
                </div>
            {% endif %}
        </div>
    {% else %}
        <div class="section">
            <div class="not-in-collection">
                <p>This book is not in your collection yet.</p>
                <p style="margin-top: 1rem; opacity: 0.7;">Add it using the + button to start tracking your progress!</p>
            </div>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const objectiveType = document.querySelectorAll('input[name="user_book_form[objective_type]"]');
    const dailyGoalGroup = document.getElementById('daily-goal-group');
    const deadlineGroup = document.getElementById('deadline-group');
    const dailyGoalInput = document.querySelector('input[name="user_book_form[daily_goal]"]');
    const deadlineInput = document.querySelector('input[name="user_book_form[deadline]"]');
    const noteModal = document.getElementById('note-modal');
    const openNoteModalButton = document.getElementById('open-note-modal');
    const closeNoteModalButton = document.getElementById('close-note-modal');
    const cancelNoteModalButton = document.getElementById('cancel-note-modal');

    function toggleFields() {
        const selected = document.querySelector('input[name="user_book_form[objective_type]"]:checked');
        if (selected && dailyGoalGroup && deadlineGroup) {
            if (selected.value === 'daily_goal') {
                dailyGoalGroup.style.display = 'block';
                deadlineGroup.style.display = 'none';
                if (deadlineInput) deadlineInput.value = '';
            } else {
                dailyGoalGroup.style.display = 'none';
                deadlineGroup.style.display = 'block';
                if (dailyGoalInput) dailyGoalInput.value = '';
            }
        }
    }

    if (objectiveType.length > 0) {
        objectiveType.forEach(radio => {
            radio.addEventListener('change', toggleFields);
        });
        // Initial state
        toggleFields();
    }

    function openNoteModal() {
        if (!noteModal) {
            return;
        }
        noteModal.classList.add('is-visible');
        noteModal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        const firstInput = noteModal.querySelector('input, textarea');
        if (firstInput) {
            setTimeout(() => firstInput.focus(), 50);
        }
    }

    function closeNoteModal() {
        if (!noteModal) {
            return;
        }
        noteModal.classList.remove('is-visible');
        noteModal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

    if (noteModal && openNoteModalButton) {
        openNoteModalButton.addEventListener('click', openNoteModal);
    }

    [closeNoteModalButton, cancelNoteModalButton].forEach(button => {
        if (button) {
            button.addEventListener('click', closeNoteModal);
        }
    });

    if (noteModal) {
        noteModal.addEventListener('click', function(event) {
            if (event.target === noteModal) {
                closeNoteModal();
            }
        });
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && noteModal && noteModal.classList.contains('is-visible')) {
            closeNoteModal();
        }
    });
});
</script>
{% endblock %}

